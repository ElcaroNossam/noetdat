# Исправление ошибки 504 Gateway Time-out

## Проблема
Gunicorn воркеры падают, что приводит к 504 ошибке. Nginx не может получить ответ от Django приложения.

## Диагностика

### 1. Проверить статус сервиса Gunicorn

```bash
sudo systemctl status noetdat.service
```

### 2. Проверить полные логи Gunicorn на наличие ошибок

```bash
# Последние 100 строк логов
sudo journalctl -u noetdat.service -n 100 --no-pager

# Или логи ошибок Gunicorn
sudo tail -100 /var/log/gunicorn/error.log

# Логи доступа
sudo tail -100 /var/log/gunicorn/access.log
```

### 3. Проверить логи Django (если настроены)

```bash
# Если логи Django настроены в settings.py
tail -100 /var/log/django/error.log
```

### 4. Проверить использование ресурсов

```bash
# CPU и память
top
# или
htop

# Проверить процессы Python
ps aux | grep python

# Проверить использование памяти
free -h

# Проверить использование диска
df -h
```

### 5. Проверить подключение к базе данных

```bash
# Проверить, работает ли PostgreSQL
sudo systemctl status postgresql

# Попробовать подключиться к базе
sudo -u postgres psql -d cryptoscreener -c "SELECT 1;"
```

## Возможные причины и решения

### 1. Воркеры падают из-за ошибок в коде Django

**Симптомы:** В логах видны Python tracebacks или ошибки импорта.

**Решение:**
```bash
# Проверить синтаксис Python файлов
cd /home/ubuntu/project/noetdat  # или ваш путь
source venv/bin/activate
python manage.py check

# Проверить миграции
python manage.py showmigrations

# Применить миграции если нужно
python manage.py migrate
```

### 2. Проблемы с базой данных

**Симптомы:** Ошибки подключения к БД в логах.

**Решение:**
```bash
# Проверить настройки БД в .env
cat .env | grep -i db

# Проверить доступность PostgreSQL
sudo systemctl restart postgresql
sudo systemctl status postgresql
```

### 3. Нехватка памяти/CPU

**Симптомы:** Высокая загрузка CPU/памяти, воркеры убиваются системой (OOM).

**Решение:**
```bash
# Уменьшить количество воркеров Gunicorn
# Отредактировать gunicorn_config.py или systemd service
sudo nano /etc/systemd/system/noetdat.service

# Изменить количество воркеров на меньшее (например, 2-3)
# Или остановить скрипты ingest временно
sudo systemctl stop noetdat-futures.service  # если есть
sudo systemctl stop noetdat-spot.service      # если есть
```

### 4. Проблемы с импортом модулей

**Симптомы:** `ModuleNotFoundError` или `ImportError` в логах.

**Решение:**
```bash
# Убедиться, что все зависимости установлены
cd /home/ubuntu/project/noetdat
source venv/bin/activate
pip install -r requirements.txt

# Проверить, что Django может загрузиться
python manage.py check
```

### 5. Проблемы с путями или правами доступа

**Симптомы:** `FileNotFoundError` или `Permission denied`.

**Решение:**
```bash
# Проверить права на файлы проекта
ls -la /home/ubuntu/project/noetdat

# Убедиться, что пользователь имеет доступ
sudo chown -R ubuntu:ubuntu /home/ubuntu/project/noetdat

# Проверить права на статические файлы
sudo chmod -R 755 /home/ubuntu/project/noetdat/staticfiles
```

## Быстрое исправление

### Шаг 1: Остановить все сервисы

```bash
sudo systemctl stop noetdat.service
sudo systemctl stop noetdat-bot.service
sudo systemctl stop noetdat-futures.service  # если есть
sudo systemctl stop noetdat-spot.service      # если есть
```

### Шаг 2: Проверить код

```bash
cd /home/ubuntu/project/noetdat  # или ваш путь к проекту
source venv/bin/activate

# Проверить Django
python manage.py check

# Проверить миграции
python manage.py showmigrations

# Применить миграции если нужно
python manage.py migrate
```

### Шаг 3: Обновить конфигурацию Gunicorn

Конфигурация уже обновлена в `gunicorn_config.py` с уменьшенным количеством воркеров.

Если нужно вручную:
```bash
# Отредактировать gunicorn_config.py
nano gunicorn_config.py

# Убедиться, что workers = 2-4 (не больше)
```

### Шаг 4: Создать директорию для логов

```bash
cd /home/ubuntu/project/noetdat  # или ваш путь
mkdir -p logs
chmod 755 logs
```

### Шаг 5: Перезапустить сервисы

```bash
# Перезагрузить systemd конфигурацию
sudo systemctl daemon-reload

# Запустить Gunicorn
sudo systemctl start noetdat.service

# Проверить статус
sudo systemctl status noetdat.service

# Посмотреть логи в реальном времени
sudo journalctl -u noetdat.service -f
```

### Шаг 6: Проверить работу

```bash
# Проверить, что воркеры запущены
ps aux | grep gunicorn

# Проверить доступность
curl -I http://127.0.0.1:8000/

# Проверить логи на ошибки
tail -50 logs/gunicorn_error.log
```

## Оптимизация конфигурации Gunicorn

### Создать/обновить gunicorn_config.py

```python
import multiprocessing

# Для небольшого сервера используйте меньше воркеров
workers = 2  # Вместо multiprocessing.cpu_count() * 2 + 1
bind = "127.0.0.1:8000"
timeout = 120
keepalive = 5
max_requests = 1000
max_requests_jitter = 50
loglevel = "info"
errorlog = "/var/log/gunicorn/error.log"
accesslog = "/var/log/gunicorn/access.log"
```

### Обновить systemd service

```bash
sudo nano /etc/systemd/system/noetdat.service
```

Убедитесь, что в `ExecStart` указан правильный путь к конфигурации:

```ini
ExecStart=/home/ubuntu/project/noetdat/venv/bin/gunicorn \
    --config /home/ubuntu/project/noetdat/gunicorn_config.py \
    config.wsgi:application
```

После изменений:
```bash
sudo systemctl daemon-reload
sudo systemctl restart noetdat.service
```

## Проверка после исправления

```bash
# 1. Проверить статус
sudo systemctl status noetdat.service

# 2. Проверить, что воркеры запущены
ps aux | grep gunicorn

# 3. Проверить доступность через curl
curl -I http://127.0.0.1:8000/

# 4. Проверить логи в реальном времени
sudo journalctl -u noetdat.service -f
```

## Если проблема сохраняется

1. **Проверить логи Nginx:**
   ```bash
   sudo tail -100 /var/log/nginx/error.log
   ```

2. **Проверить конфигурацию Nginx:**
   ```bash
   sudo nginx -t
   sudo cat /etc/nginx/sites-available/noetdat
   ```

3. **Проверить, что Gunicorn слушает на правильном порту:**
   ```bash
   sudo netstat -tulpn | grep 8000
   # или
   sudo ss -tulpn | grep 8000
   ```

4. **Попробовать запустить Gunicorn вручную для отладки:**
   ```bash
   cd /home/ubuntu/project/noetdat
   source venv/bin/activate
   gunicorn --bind 127.0.0.1:8000 config.wsgi:application
   ```

