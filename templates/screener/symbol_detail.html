{% extends "base.html" %}
{% load formatting %}

{% block title %}{% endblock %}

{% block content %}
<div class="symbol-detail-container" data-symbol-detail data-symbol="{{ symbol.symbol }}">
    <div class="symbol-detail-header">
        <h1>{{ symbol.symbol }}</h1>
        <a href="{% url 'screener:trading_terminal' symbol.symbol %}?market_type={{ market_type }}" class="btn-primary trading-terminal-btn">
            üìà –¢–æ—Ä–≥–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª
        </a>
    </div>
    {% if latest_snapshot %}
        <div class="symbol-summary">
            <div class="metric">
                <span class="label">Price</span>
                <span class="value" id="symbol-price">{{ latest_snapshot.price|format_price }}</span>
            </div>
            <div class="metric">
                <span class="label">Volatility 15m</span>
                <span class="value" id="symbol-volatility-15m">{{ latest_snapshot.volatility_15m|floatformat:2 }}</span>
            </div>
            <div class="metric">
                <span class="label">Volume 5m</span>
                <span class="value" id="symbol-volume-5m">{{ latest_snapshot.volume_5m|floatformat:2 }}</span>
            </div>
            <div class="metric">
                <span class="label">OI Œî 15m</span>
                <span class="value {% if latest_snapshot.oi_change_15m > 0 %}value-up{% elif latest_snapshot.oi_change_15m < 0 %}value-down{% endif %}"
                      id="symbol-oi-change-15m">
                    {{ latest_snapshot.oi_change_15m|floatformat:3 }}
                </span>
            </div>
            <div class="metric">
                <span class="label">Funding</span>
                <span class="value {% if latest_snapshot.funding_rate > 0 %}value-up{% elif latest_snapshot.funding_rate < 0 %}value-down{% endif %}"
                      id="symbol-funding-rate">
                    {{ latest_snapshot.funding_rate|floatformat:6 }}
                </span>
            </div>
            <div class="metric">
                <span class="label">OI</span>
                <span class="value" id="symbol-open-interest">{{ latest_snapshot.open_interest|floatformat:0 }}</span>
            </div>
            <div class="metric">
                <span class="label">Updated</span>
                <span class="value" id="symbol-updated-at">{{ latest_snapshot.ts }}</span>
            </div>
        </div>

        <div class="symbol-chart">
            <canvas id="priceChart" width="800" height="200"></canvas>
            <p class="chart-note">–õ—ë–≥–∫–∏–π stub-–≥—Ä–∞—Ñ–∏–∫: –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ `/api/symbol/{{ symbol.symbol }}/`.</p>
        </div>
    {% else %}
        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —ç—Ç–æ–º—É —Å–∏–º–≤–æ–ª—É.</p>
    {% endif %}

    <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ snapshot'—ã</h2>
    <div class="screener-table-wrapper">
        <table class="screener-table">
            <thead>
            <tr>
                <th>TS</th>
                <th>Price</th>
                <th>Change 15m %</th>
                <th>Volume 15m</th>
                <th>OI</th>
                <th>OI Œî 15m %</th>
                <th>Funding</th>
            </tr>
            </thead>
            <tbody id="symbol-history-body">
            {% for s in snapshots %}
                <tr>
                    <td>{{ s.ts }}</td>
                    <td>{{ s.price|format_price }}</td>
                    <td class="{% if s.change_15m > 0 %}value-up{% elif s.change_15m < 0 %}value-down{% endif %}">
                        {{ s.change_15m|floatformat:2 }}
                    </td>
                    <td>{{ s.volume_15m|floatformat:2 }}</td>
                    <td>{{ s.open_interest|floatformat:0 }}</td>
                    <td class="{% if s.oi_change_15m > 0 %}value-up{% elif s.oi_change_15m < 0 %}value-down{% endif %}">
                        {{ s.oi_change_15m|floatformat:3 }}
                    </td>
                    <td class="{% if s.funding_rate > 0 %}value-up{% elif s.funding_rate < 0 %}value-down{% endif %}">
                        {{ s.funding_rate|floatformat:6 }}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="8" class="empty-row">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if request.user.is_authenticated %}
        <h2>–°–æ–∑–¥–∞—Ç—å –∞–ª–µ—Ä—Ç</h2>
        <div class="auth-form">
            <form method="post" action="{% url 'alerts:create' symbol.symbol %}?market_type={{ market_type }}">
                {% csrf_token %}
                <input type="hidden" name="market_type" value="{{ market_type }}">
                <div class="form-field">
                    <label for="metric">–ú–µ—Ç—Ä–∏–∫–∞</label>
                    <select name="metric" id="metric">
                        <option value="change_15m">Change 15m %</option>
                        <option value="oi_change_15m">OI change 15m %</option>
                        <option value="volume_15m">Volume 15m</option>
                        <option value="funding_rate">Funding rate</option>
                        <option value="vdelta_15m">Vdelta 15m</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="operator">–û–ø–µ—Ä–∞—Ç–æ—Ä</label>
                    <select name="operator" id="operator">
                        <option value=">">&gt;</option>
                        <option value="<">&lt;</option>
                        <option value=">=">&gt;=</option>
                        <option value="<=">&lt;=</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="threshold">–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
                    <input type="number" step="0.0001" name="threshold" id="threshold">
                </div>
                <div class="form-field">
                    <label for="telegram_chat_id">Telegram chat id</label>
                    <input type="number" name="telegram_chat_id" id="telegram_chat_id">
                </div>
                <p class="chart-note">
                    Telegram chat id –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å, –Ω–∞–ø–∏—Å–∞–≤ –≤–∞—à–µ–º—É –±–æ—Ç—É –∏ –ø–æ—Å–º–æ—Ç—Ä–µ–≤ id –≤ –æ—Ç–≤–µ—Ç–µ
                    –ª–∏–±–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã–µ –±–æ—Ç—ã –≤—Ä–æ–¥–µ @userinfobot.
                </p>
                <button type="submit" class="btn-primary">–°–æ–∑–¥–∞—Ç—å –∞–ª–µ—Ä—Ç</button>
            </form>
        </div>
    {% else %}
        <p class="chart-note">
            <a href="{% url 'accounts:login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞–ª–µ—Ä—Ç—ã –ø–æ —ç—Ç–æ–º—É —Å–∏–º–≤–æ–ª—É.
        </p>
    {% endif %}
</div>
{% endblock %}


