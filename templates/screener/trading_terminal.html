{% extends "base.html" %}
{% load static %}
{% load formatting %}

{% block title %}Торговый терминал — {{ symbol.symbol }}{% endblock %}


{% block content %}
<div class="trading-terminal-container">
    <div class="trading-header">
        <div class="trading-symbol-info">
            <h1>{{ symbol.symbol }}</h1>
            <span class="market-type-badge {% if market_type == 'futures' %}futures{% else %}spot{% endif %}">
                {{ market_type|upper }}
            </span>
            {% if latest_snapshot %}
                <div class="price-info">
                    <span class="current-price" id="current-price">{{ latest_snapshot.price|format_price }}</span>
                    <span class="price-change {% if latest_snapshot.change_15m > 0 %}positive{% elif latest_snapshot.change_15m < 0 %}negative{% endif %}" id="price-change">
                        {{ latest_snapshot.change_15m|floatformat:2 }}%
                    </span>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="trading-chart-container">
        <div id="tradingview-widget-container" class="tradingview-widget-container">
            <div id="tradingview-widget" class="tradingview-widget"></div>
        </div>
    </div>

    <div class="trading-sidebar">
        <div class="trading-stats">
            <h3>Статистика</h3>
            {% if latest_snapshot %}
                <div class="stat-item">
                    <span class="stat-label">Volume 15m:</span>
                    <span class="stat-value">{{ latest_snapshot.volume_15m|format_volume }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">OI Change 15m:</span>
                    <span class="stat-value {% if latest_snapshot.oi_change_15m > 0 %}positive{% elif latest_snapshot.oi_change_15m < 0 %}negative{% endif %}">
                        {{ latest_snapshot.oi_change_15m|floatformat:2 }}%
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Funding Rate:</span>
                    <span class="stat-value">{{ latest_snapshot.funding_rate|floatformat:4 }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Open Interest:</span>
                    <span class="stat-value">{{ latest_snapshot.open_interest|format_volume }}</span>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const symbol = '{{ symbol.symbol }}';
    const exchange = '{{ market_type|upper }}';
    const marketType = '{{ market_type }}';
    
    function calculateChartHeight() {
        // Настройки для максимального использования экрана (как в TradingView)
        const windowHeight = window.innerHeight;
        const headerHeight = document.querySelector('.trading-header')?.offsetHeight || 80;
        const padding = 20; // Минимальный отступ
        
        // Высота = высота окна - хедер - минимальный отступ
        // Это даст графику максимальное пространство
        let calculatedHeight = windowHeight - headerHeight - padding;
        
        // Минимальная высота для очень маленьких экранов
        calculatedHeight = Math.max(300, calculatedHeight);
        
        return calculatedHeight;
    }
    
    function initTradingView() {
        const chartHeight = calculateChartHeight();
        const widgetConfig = {
            "autosize": true,
            "symbol": `BINANCE:${symbol}`,
            "interval": "1",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "ru",
            "toolbar_bg": "#0b0c10",
            "enable_publishing": false,
            "hide_top_toolbar": false,
            "hide_legend": false,
            "save_image": false,
            "container_id": "tradingview-widget",
            "height": chartHeight,
            "width": "100%"
        };
        
        new TradingView.widget(widgetConfig);
    }
    
    // Обновление высоты графика при изменении размера окна
    let resizeTimeout;
    let tradingViewWidget = null;
    
    function updateChartHeight() {
        const container = document.getElementById('tradingview-widget-container');
        if (container) {
            const chartHeight = calculateChartHeight();
            container.style.height = chartHeight + 'px';
            // Обновляем виджет TradingView, если он уже создан
            if (tradingViewWidget && tradingViewWidget.ready) {
                tradingViewWidget.setAttribute('height', chartHeight);
            }
        }
    }
    
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(updateChartHeight, 250);
    });
    
    initTradingView();
    
    // Сохраняем ссылку на виджет для последующего обновления
    setTimeout(function() {
        tradingViewWidget = document.getElementById('tradingview-widget');
    }, 1000);
    
    setInterval(function() {
        fetch(`/api/symbol/${symbol}/?market_type=${marketType}`)
            .then(res => res.json())
            .then(data => {
                if (data.latest) {
                    document.getElementById('current-price').textContent = parseFloat(data.latest.price).toFixed(8);
                    const change = parseFloat(data.latest.change_15m || 0);
                    const changeEl = document.getElementById('price-change');
                    changeEl.textContent = change.toFixed(2) + '%';
                    changeEl.className = 'price-change ' + (change > 0 ? 'positive' : change < 0 ? 'negative' : '');
                }
            })
            .catch(err => console.error('Failed to update price:', err));
    }, 5000);
});
</script>
{% endblock %}

