{% extends "base.html" %}
{% load static %}
{% load formatting %}

{% block title %}Торговый терминал — {{ symbol.symbol }}{% endblock %}


{% block content %}
<div class="trading-terminal-container">
    <div class="trading-header">
        <div class="trading-symbol-info">
            <h1>{{ symbol.symbol }}</h1>
            <span class="market-type-badge {% if market_type == 'futures' %}futures{% else %}spot{% endif %}">
                {{ market_type|upper }}
            </span>
            {% if latest_snapshot %}
                <div class="price-info">
                    <span class="current-price" id="current-price">{{ latest_snapshot.price|format_price }}</span>
                    <span class="price-change {% if latest_snapshot.change_15m > 0 %}positive{% elif latest_snapshot.change_15m < 0 %}negative{% endif %}" id="price-change">
                        {{ latest_snapshot.change_15m|floatformat:2 }}%
                    </span>
                </div>
            {% endif %}
        </div>
        {% if latest_snapshot %}
            <div class="trading-stats-inline">
                <div class="stat-item-inline">
                    <span class="stat-label">Vol 15m:</span>
                    <span class="stat-value">{{ latest_snapshot.volume_15m|format_volume }}</span>
                </div>
                <div class="stat-item-inline">
                    <span class="stat-label">OI Δ 15m:</span>
                    <span class="stat-value {% if latest_snapshot.oi_change_15m > 0 %}positive{% elif latest_snapshot.oi_change_15m < 0 %}negative{% endif %}">
                        {{ latest_snapshot.oi_change_15m|floatformat:2 }}%
                    </span>
                </div>
                <div class="stat-item-inline">
                    <span class="stat-label">Funding:</span>
                    <span class="stat-value">{{ latest_snapshot.funding_rate|floatformat:4 }}</span>
                </div>
                <div class="stat-item-inline">
                    <span class="stat-label">OI:</span>
                    <span class="stat-value">{{ latest_snapshot.open_interest|format_volume }}</span>
                </div>
            </div>
        {% endif %}
    </div>

    <div class="trading-chart-container">
        <div id="tradingview-widget-container" class="tradingview-widget-container">
            <div id="tradingview-widget" class="tradingview-widget"></div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const symbol = '{{ symbol.symbol }}';
    const exchange = '{{ market_type|upper }}';
    const marketType = '{{ market_type }}';
    
    function calculateChartHeight() {
        // Высота = высота окна - высота хедера
        const windowHeight = window.innerHeight;
        const headerHeight = document.querySelector('.trading-header')?.offsetHeight || 100;
        const calculatedHeight = windowHeight - headerHeight;
        
        // Минимальная высота для маленьких экранов
        return Math.max(400, calculatedHeight);
    }
    
    function initTradingView() {
        // Небольшая задержка для правильного расчета высоты после применения flexbox
        setTimeout(function() {
            const chartHeight = calculateChartHeight();
            const widgetConfig = {
                "autosize": true,
                "symbol": `BINANCE:${symbol}`,
                "interval": "1",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "ru",
                "toolbar_bg": "#0b0c10",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "container_id": "tradingview-widget",
                "height": chartHeight,
                "width": "100%"
            };
            
            new TradingView.widget(widgetConfig);
        }, 200);
    }
    
    // Обновление высоты графика при изменении размера окна
    let resizeTimeout;
    let tradingViewWidget = null;
    
    function updateChartHeight() {
        // При использовании flexbox высота обновляется автоматически
        // Но можно принудительно обновить, если нужно
        const container = document.getElementById('tradingview-widget-container');
        if (container && tradingViewWidget) {
            const chartHeight = calculateChartHeight();
            // TradingView автоматически адаптируется к размеру контейнера
        }
    }
    
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(updateChartHeight, 250);
    });
    
    initTradingView();
    
    // Сохраняем ссылку на виджет для последующего обновления
    setTimeout(function() {
        tradingViewWidget = document.getElementById('tradingview-widget');
    }, 1000);
    
    setInterval(function() {
        fetch(`/api/symbol/${symbol}/?market_type=${marketType}`)
            .then(res => res.json())
            .then(data => {
                if (data.latest) {
                    document.getElementById('current-price').textContent = parseFloat(data.latest.price).toFixed(8);
                    const change = parseFloat(data.latest.change_15m || 0);
                    const changeEl = document.getElementById('price-change');
                    changeEl.textContent = change.toFixed(2) + '%';
                    changeEl.className = 'price-change ' + (change > 0 ? 'positive' : change < 0 ? 'negative' : '');
                }
            })
            .catch(err => console.error('Failed to update price:', err));
    }, 5000);
});
</script>
{% endblock %}

