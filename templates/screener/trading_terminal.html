{% extends "base.html" %}
{% load static %}
{% load formatting %}

{% block title %}Ð¢Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ð¹ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» â€” {{ symbol.symbol }}{% endblock %}


{% block content %}
<div class="trading-terminal-container">
    <div class="trading-header">
        <div class="trading-symbol-info">
            <h1>{{ symbol.symbol }}</h1>
            <span class="market-type-badge {% if market_type == 'futures' %}futures{% else %}spot{% endif %}">
                {{ market_type|upper }}
            </span>
            {% if latest_snapshot %}
                <div class="price-info">
                    <span class="current-price" id="current-price">{{ latest_snapshot.price|format_price }}</span>
                    <span class="price-change {% if latest_snapshot.change_15m > 0 %}positive{% elif latest_snapshot.change_15m < 0 %}negative{% endif %}" id="price-change">
                        {{ latest_snapshot.change_15m|floatformat:2 }}%
                    </span>
                </div>
            {% endif %}
        </div>
        <div class="trading-header-actions">
            <a href="{% url 'alerts:create' symbol.symbol %}?market_type={{ market_type }}" class="btn-primary">
                ðŸ”” Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð°Ð»ÐµÑ€Ñ‚
            </a>
        </div>
        {% if latest_snapshot %}
            <div class="trading-stats-inline">
                <div class="stat-item-inline">
                    <span class="stat-label">Vol 15m:</span>
                    <span class="stat-value">{{ latest_snapshot.volume_15m|format_volume }}</span>
                </div>
                <div class="stat-item-inline">
                    <span class="stat-label">OI Î” 15m:</span>
                    <span class="stat-value {% if latest_snapshot.oi_change_15m > 0 %}positive{% elif latest_snapshot.oi_change_15m < 0 %}negative{% endif %}">
                        {{ latest_snapshot.oi_change_15m|floatformat:2 }}%
                    </span>
                </div>
                <div class="stat-item-inline">
                    <span class="stat-label">Funding:</span>
                    <span class="stat-value">{{ latest_snapshot.funding_rate|floatformat:4 }}</span>
                </div>
                <div class="stat-item-inline">
                    <span class="stat-label">OI:</span>
                    <span class="stat-value">{{ latest_snapshot.open_interest|format_volume }}</span>
                </div>
            </div>
        {% endif %}
    </div>

    <div class="trading-chart-container">
        <div id="tradingview-widget-container" class="tradingview-widget-container">
            <div id="tradingview-widget" class="tradingview-widget"></div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const symbol = '{{ symbol.symbol }}';
    const exchange = '{{ market_type|upper }}';
    const marketType = '{{ market_type }}';
    
    function calculateChartHeight() {
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ€ÐµÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð²Ñ‹ÑÐ¾Ñ‚Ñƒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· getBoundingClientRect
        const chartContainer = document.querySelector('.trading-chart-container');
        if (chartContainer) {
            const rect = chartContainer.getBoundingClientRect();
            if (rect.height > 100) {
                return rect.height;
            }
        }
        
        // Fallback: Ñ€Ð°ÑÑ‡ÐµÑ‚ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¾ÐºÐ½Ð° Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ð½Ð°Ð²Ð±Ð°Ñ€Ð°
        const windowHeight = window.innerHeight;
        const navbar = document.querySelector('.navbar');
        const navbarHeight = navbar ? navbar.getBoundingClientRect().height : 60;
        const header = document.querySelector('.trading-header');
        const headerHeight = header ? header.getBoundingClientRect().height : 100;
        
        const calculatedHeight = windowHeight - navbarHeight - headerHeight;
        
        // Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð²Ñ‹ÑÐ¾Ñ‚Ñƒ Ð² 5 Ñ€Ð°Ð· (ÐºÐ°Ðº Ð¿Ñ€Ð¾ÑÐ¸Ð» Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ)
        const finalHeight = calculatedHeight * 5;
        
        // ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð²Ñ‹ÑÐ¾Ñ‚Ð° Ð´Ð»Ñ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ñ… ÑÐºÑ€Ð°Ð½Ð¾Ð² (Ñ‚Ð°ÐºÐ¶Ðµ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð½Ð°Ñ)
        return Math.max(2500, finalHeight);
    }
    
    function initTradingView() {
        // Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð´Ð»Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð²Ñ‹ÑÐ¾Ñ‚Ñ‹ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ flexbox
        setTimeout(function() {
            const chartHeight = calculateChartHeight();
            console.log('Chart height calculated:', chartHeight);
            
            const container = document.getElementById('tradingview-widget-container');
            if (container) {
                container.style.height = chartHeight + 'px';
            }
            
            const widgetConfig = {
                "autosize": true,
                "symbol": `BINANCE:${symbol}`,
                "interval": "1",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "ru",
                "toolbar_bg": "#0b0c10",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "container_id": "tradingview-widget",
                "height": chartHeight,
                "width": "100%"
            };
            
            new TradingView.widget(widgetConfig);
        }, 500);
    }
    
    // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ‹ÑÐ¾Ñ‚Ñ‹ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ° Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ð¾ÐºÐ½Ð°
    let resizeTimeout;
    let tradingViewWidget = null;
    
    function updateChartHeight() {
        // ÐŸÑ€Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ð¸ flexbox Ð²Ñ‹ÑÐ¾Ñ‚Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
        // ÐÐ¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
        const container = document.getElementById('tradingview-widget-container');
        if (container && tradingViewWidget) {
            const chartHeight = calculateChartHeight();
            // TradingView Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ðº Ñ€Ð°Ð·Ð¼ÐµÑ€Ñƒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
        }
    }
    
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(updateChartHeight, 250);
    });
    
    initTradingView();
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° Ð²Ð¸Ð´Ð¶ÐµÑ‚ Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
    setTimeout(function() {
        tradingViewWidget = document.getElementById('tradingview-widget');
    }, 1000);
    
    setInterval(function() {
        fetch(`/api/symbol/${symbol}/?market_type=${marketType}`)
            .then(res => res.json())
            .then(data => {
                if (data.latest) {
                    document.getElementById('current-price').textContent = parseFloat(data.latest.price).toFixed(8);
                    const change = parseFloat(data.latest.change_15m || 0);
                    const changeEl = document.getElementById('price-change');
                    changeEl.textContent = change.toFixed(2) + '%';
                    changeEl.className = 'price-change ' + (change > 0 ? 'positive' : change < 0 ? 'negative' : '');
                }
            })
            .catch(err => console.error('Failed to update price:', err));
    }, 5000);
});
</script>
{% endblock %}

