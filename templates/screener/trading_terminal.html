{% extends "base.html" %}
{% load static %}
{% load formatting %}

{% block title %}Торговый терминал — {{ symbol.symbol }}{% endblock %}


{% block content %}
<div class="trading-terminal-container">
    <div class="trading-header">
        <div class="trading-symbol-info">
            <h1>{{ symbol.symbol }}</h1>
            <span class="market-type-badge {% if market_type == 'futures' %}futures{% else %}spot{% endif %}">
                {{ market_type|upper }}
            </span>
            {% if latest_snapshot %}
                <div class="price-info">
                    <span class="current-price" id="current-price">{{ latest_snapshot.price|format_price }}</span>
                    <span class="price-change {% if latest_snapshot.change_15m > 0 %}positive{% elif latest_snapshot.change_15m < 0 %}negative{% endif %}" id="price-change">
                        {{ latest_snapshot.change_15m|floatformat:2 }}%
                    </span>
                </div>
            {% endif %}
        </div>
        <div class="trading-controls">
            <div class="timeframe-selector">
                <button class="timeframe-btn active" data-timeframe="1">1m</button>
                <button class="timeframe-btn" data-timeframe="5">5m</button>
                <button class="timeframe-btn" data-timeframe="15">15m</button>
                <button class="timeframe-btn" data-timeframe="60">1h</button>
                <button class="timeframe-btn" data-timeframe="240">4h</button>
                <button class="timeframe-btn" data-timeframe="D">1D</button>
            </div>
            <div class="indicator-selector">
                <select id="indicator-select" class="indicator-select">
                    <option value="">Добавить индикатор...</option>
                    <optgroup label="Скользящие средние">
                        <option value="sma">SMA (Simple Moving Average)</option>
                        <option value="ema">EMA (Exponential Moving Average)</option>
                        <option value="wma">WMA (Weighted Moving Average)</option>
                    </optgroup>
                    <optgroup label="Осцилляторы">
                        <option value="rsi">RSI (Relative Strength Index)</option>
                        <option value="stochastic">Stochastic</option>
                        <option value="williams">Williams %R</option>
                        <option value="cci">CCI (Commodity Channel Index)</option>
                        <option value="adx">ADX (Average Directional Index)</option>
                    </optgroup>
                    <optgroup label="Трендовые">
                        <option value="macd">MACD</option>
                        <option value="bollinger">Bollinger Bands</option>
                        <option value="atr">ATR (Average True Range)</option>
                        <option value="parabolic">Parabolic SAR</option>
                    </optgroup>
                    <optgroup label="Объем">
                        <option value="volume">Volume</option>
                        <option value="vwap">VWAP</option>
                    </optgroup>
                    <optgroup label="Дополнительные">
                        <option value="ichimoku">Ichimoku Cloud</option>
                        <option value="pivot">Pivot Points</option>
                        <option value="fibonacci">Fibonacci Retracement</option>
                    </optgroup>
                </select>
                <button id="add-indicator" class="btn-secondary">Добавить</button>
            </div>
        </div>
    </div>

    <div class="trading-chart-container">
        <div id="tradingview-widget-container" class="tradingview-widget-container">
            <div id="tradingview-widget" class="tradingview-widget"></div>
        </div>
        <div id="indicators-list" class="indicators-list"></div>
    </div>

    <div class="trading-sidebar">
        <div class="trading-stats">
            <h3>Статистика</h3>
            {% if latest_snapshot %}
                <div class="stat-item">
                    <span class="stat-label">Volume 15m:</span>
                    <span class="stat-value">{{ latest_snapshot.volume_15m|format_volume }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">OI Change 15m:</span>
                    <span class="stat-value {% if latest_snapshot.oi_change_15m > 0 %}positive{% elif latest_snapshot.oi_change_15m < 0 %}negative{% endif %}">
                        {{ latest_snapshot.oi_change_15m|floatformat:2 }}%
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Funding Rate:</span>
                    <span class="stat-value">{{ latest_snapshot.funding_rate|floatformat:4 }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Open Interest:</span>
                    <span class="stat-value">{{ latest_snapshot.open_interest|format_volume }}</span>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const symbol = '{{ symbol.symbol }}';
    const exchange = '{{ market_type|upper }}';
    const marketType = '{{ market_type }}';
    
    let currentTimeframe = '1';
    const activeIndicators = [];
    
    function initTradingView() {
        const widgetConfig = {
            "autosize": true,
            "symbol": `BINANCE:${symbol}`,
            "interval": currentTimeframe,
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "ru",
            "toolbar_bg": "#0b0c10",
            "enable_publishing": false,
            "hide_top_toolbar": false,
            "hide_legend": false,
            "save_image": false,
            "container_id": "tradingview-widget",
            "height": 600,
            "width": "100%"
        };
        
        if (activeIndicators.length > 0) {
            widgetConfig.studies = activeIndicators;
            widgetConfig.studies_overrides = {};
        }
        
        new TradingView.widget(widgetConfig);
    }
    
    document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTimeframe = this.dataset.timeframe;
            initTradingView();
        });
    });
    
    function getIndicatorConfig(code) {
        const configs = {
            'sma': 'MASimple@tv-basicstudies',
            'ema': 'MAExp@tv-basicstudies',
            'wma': 'MAWeighted@tv-basicstudies',
            'rsi': 'RSI@tv-basicstudies',
            'stochastic': 'Stochastic@tv-basicstudies',
            'williams': 'WilliamsR@tv-basicstudies',
            'cci': 'CCI@tv-basicstudies',
            'adx': 'ADX@tv-basicstudies',
            'macd': 'MACD@tv-basicstudies',
            'bollinger': 'BB@tv-basicstudies',
            'atr': 'ATR@tv-basicstudies',
            'parabolic': 'ParabolicSAR@tv-basicstudies',
            'volume': 'Volume@tv-basicstudies',
            'vwap': 'VWAP@tv-basicstudies',
            'ichimoku': 'IchimokuCloud@tv-basicstudies',
            'pivot': 'PivotPointsHighLow@tv-basicstudies',
            'fibonacci': 'FibRetracement@tv-basicstudies'
        };
        return configs[code] || code;
    }
    
    function getIndicatorName(config) {
        const code = config.split('@')[0];
        const names = {
            'MASimple': 'SMA',
            'MAExp': 'EMA',
            'MAWeighted': 'WMA',
            'RSI': 'RSI',
            'Stochastic': 'Stochastic',
            'WilliamsR': 'Williams %R',
            'CCI': 'CCI',
            'ADX': 'ADX',
            'MACD': 'MACD',
            'BB': 'Bollinger Bands',
            'ATR': 'ATR',
            'ParabolicSAR': 'Parabolic SAR',
            'Volume': 'Volume',
            'VWAP': 'VWAP',
            'IchimokuCloud': 'Ichimoku Cloud',
            'PivotPointsHighLow': 'Pivot Points',
            'FibRetracement': 'Fibonacci'
        };
        return names[code] || code;
    }
    
    document.getElementById('add-indicator').addEventListener('click', function() {
        const select = document.getElementById('indicator-select');
        const indicatorCode = select.value;
        if (indicatorCode) {
            const indicatorConfig = getIndicatorConfig(indicatorCode);
            if (!activeIndicators.includes(indicatorConfig)) {
                activeIndicators.push(indicatorConfig);
                updateIndicatorsList();
                initTradingView();
                select.value = '';
            }
        }
    });
    
    function updateIndicatorsList() {
        const list = document.getElementById('indicators-list');
        if (activeIndicators.length === 0) {
            list.innerHTML = '';
            return;
        }
        list.innerHTML = '<h4>Активные индикаторы:</h4>';
        activeIndicators.forEach((ind, index) => {
            const item = document.createElement('div');
            item.className = 'indicator-item';
            item.innerHTML = `
                <span>${getIndicatorName(ind)}</span>
                <button class="btn-small btn-danger" onclick="removeIndicator(${index})">Удалить</button>
            `;
            list.appendChild(item);
        });
    }
    
    window.removeIndicator = function(index) {
        activeIndicators.splice(index, 1);
        updateIndicatorsList();
        initTradingView();
    };
    
    initTradingView();
    
    setInterval(function() {
        fetch(`/api/symbol/${symbol}/?market_type=${marketType}`)
            .then(res => res.json())
            .then(data => {
                if (data.latest) {
                    document.getElementById('current-price').textContent = parseFloat(data.latest.price).toFixed(8);
                    const change = parseFloat(data.latest.change_15m || 0);
                    const changeEl = document.getElementById('price-change');
                    changeEl.textContent = change.toFixed(2) + '%';
                    changeEl.className = 'price-change ' + (change > 0 ? 'positive' : change < 0 ? 'negative' : '');
                }
            })
            .catch(err => console.error('Failed to update price:', err));
    }, 5000);
});
</script>
{% endblock %}

