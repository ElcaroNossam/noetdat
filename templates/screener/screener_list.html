{% extends "base.html" %}
{% load formatting %}
{% load i18n %}

{% block title %}{% endblock %}

{% block content %}
<div class="screener-container">
    <h1>{% trans "Crypto Screener" %}</h1>
    <div class="market-type-toggle">
        <button type="button" class="market-type-btn {% if market_type == 'futures' %}active{% endif %}" data-market-type="futures">{% trans "Futures" %}</button>
        <button type="button" class="market-type-btn {% if market_type == 'spot' %}active{% endif %}" data-market-type="spot">{% trans "Spot" %}</button>
    </div>
    <form method="get" class="screener-filters">
        <input type="hidden" id="market_type_hidden" name="market_type" value="{{ market_type }}">
        <input type="text" id="search" name="search" placeholder="{% trans 'Search by symbol' %}" value="{{ search }}">
        <input type="number" id="min_volume_15m" step="0.0001" name="min_volume_15m" placeholder="{% trans 'Min volume 15m' %}"
               value="{{ min_volume_15m }}">
        <input type="number" id="max_volume_15m" step="0.0001" name="max_volume_15m" placeholder="{% trans 'Max volume 15m' %}"
               value="{{ max_volume_15m }}">
        <input type="number" id="min_change_15m" step="0.01" name="min_change_15m" placeholder="{% trans 'Min change 15m %' %}"
               value="{{ min_change_15m }}">
        <input type="number" id="max_change_15m" step="0.01" name="max_change_15m" placeholder="{% trans 'Max change 15m %' %}"
               value="{{ max_change_15m }}">
        <input type="number" id="min_oi_change_15m" step="0.01" name="min_oi_change_15m" placeholder="{% trans 'Min OI Δ 15m %' %}"
               value="{{ min_oi_change_15m }}">
        <input type="number" id="min_open_interest" step="1" name="min_open_interest" placeholder="{% trans 'Min OI' %}"
               value="{{ min_open_interest }}">
        <input type="number" id="max_open_interest" step="1" name="max_open_interest" placeholder="{% trans 'Max OI' %}"
               value="{{ max_open_interest }}">
        <input type="number" id="min_funding_rate" step="0.0001" name="min_funding_rate" placeholder="{% trans 'Min funding' %}"
               value="{{ min_funding_rate }}">
        <input type="number" id="max_funding_rate" step="0.0001" name="max_funding_rate" placeholder="{% trans 'Max funding' %}"
               value="{{ max_funding_rate }}">
        <button type="submit" class="btn-secondary">{% trans "Filter" %}</button>
        <button type="button" id="toggle-settings" class="btn-secondary">{% trans "Screener Settings" %}</button>
    </form>

    <div class="screener-table-container">
        <div class="screener-table-scrollbar-top" id="top-scrollbar">
            <div class="scrollbar-spacer" id="scrollbar-spacer"></div>
        </div>
        <div class="screener-table-wrapper" id="table-wrapper">
            <table class="screener-table" id="screener-main-table">
            <thead id="screener-table-head">
            <tr>
                <th data-column="symbol" class="sortable">{% trans "Symbol" %}</th>
                <th data-column="price" class="sortable">{% trans "Price" %}</th>
                <th data-column="change_5m" class="sortable">{% trans "Change 5m" %}</th>
                <th data-column="change_15m" class="sortable">{% trans "Change 15m" %}</th>
                <th data-column="change_1h" class="sortable">{% trans "Change 1h" %}</th>
                <th data-column="change_8h" class="sortable">{% trans "Change 8h" %}</th>
                <th data-column="change_1d" class="sortable">{% trans "Change 1d" %}</th>
                <th data-column="oi_change_5m" class="sortable">{% trans "OI Δ 5m" %}</th>
                <th data-column="oi_change_15m" class="sortable">{% trans "OI Δ 15m" %}</th>
                <th data-column="oi_change_1h" class="sortable">{% trans "OI Δ 1h" %}</th>
                <th data-column="oi_change_8h" class="sortable">{% trans "OI Δ 8h" %}</th>
                <th data-column="oi_change_1d" class="sortable">{% trans "OI Δ 1d" %}</th>
                <th data-column="volatility_5m" class="sortable">{% trans "Vol 5m" %}</th>
                <th data-column="volatility_15m" class="sortable">{% trans "Vol 15m" %}</th>
                <th data-column="volatility_1h" class="sortable">{% trans "Vol 1h" %}</th>
                <th data-column="ticks_5m" class="sortable">{% trans "Ticks 5m" %}</th>
                <th data-column="ticks_15m" class="sortable">{% trans "Ticks 15m" %}</th>
                <th data-column="ticks_1h" class="sortable">{% trans "Ticks 1h" %}</th>
                <th data-column="vdelta_5m" class="sortable">{% trans "Vdelta 5m" %}</th>
                <th data-column="vdelta_15m" class="sortable">{% trans "Vdelta 15m" %}</th>
                <th data-column="vdelta_1h" class="sortable">{% trans "Vdelta 1h" %}</th>
                <th data-column="vdelta_8h" class="sortable">{% trans "Vdelta 8h" %}</th>
                <th data-column="vdelta_1d" class="sortable">{% trans "Vdelta 1d" %}</th>
                <th data-column="volume_5m" class="sortable">{% trans "Volume 5m" %}</th>
                <th data-column="volume_15m" class="sortable">{% trans "Volume 15m" %}</th>
                <th data-column="volume_1h" class="sortable">{% trans "Volume 1h" %}</th>
                <th data-column="volume_8h" class="sortable">{% trans "Volume 8h" %}</th>
                <th data-column="volume_1d" class="sortable">{% trans "Volume 1d" %}</th>
                <th data-column="funding_rate" class="sortable">{% trans "Funding" %}</th>
                <th data-column="open_interest" class="sortable">{% trans "OI" %}</th>
                <th data-column="ts" class="sortable">{% trans "Updated" %}</th>
            </tr>
            </thead>
            <tbody id="screener-table-body">
            {% for snapshot in page_obj %}
                <tr>
                    <td data-column="symbol">
                        <a href="{% url 'screener:trading_terminal' snapshot.symbol.symbol %}?market_type={{ market_type }}">
                            {{ snapshot.symbol.symbol }}
                        </a>
                    </td>
                    <td data-column="price" class="price-cell">{{ snapshot.price|format_price }}</td>
                    <td data-column="change_5m" class="change-cell">{{ snapshot.change_5m|format_percentage:2 }}%</td>
                    <td data-column="change_15m" class="change-cell">{{ snapshot.change_15m|format_percentage:2 }}%</td>
                    <td data-column="change_1h" class="change-cell">{{ snapshot.change_1h|format_percentage:2 }}%</td>
                    <td data-column="change_8h" class="change-cell">{{ snapshot.change_8h|format_percentage:2 }}%</td>
                    <td data-column="change_1d" class="change-cell">{{ snapshot.change_1d|format_percentage:2 }}%</td>
                    <td data-column="oi_change_5m" class="oi-change-cell">{{ snapshot.oi_change_5m|format_oi_change }}%</td>
                    <td data-column="oi_change_15m" class="oi-change-cell">{{ snapshot.oi_change_15m|format_oi_change }}%</td>
                    <td data-column="oi_change_1h" class="oi-change-cell">{{ snapshot.oi_change_1h|format_oi_change }}%</td>
                    <td data-column="oi_change_8h" class="oi-change-cell">{{ snapshot.oi_change_8h|format_oi_change }}%</td>
                    <td data-column="oi_change_1d" class="oi-change-cell">{{ snapshot.oi_change_1d|format_oi_change }}%</td>
                    <td data-column="volatility_5m" class="volatility-cell">{{ snapshot.volatility_5m|format_volatility }}</td>
                    <td data-column="volatility_15m" class="volatility-cell">{{ snapshot.volatility_15m|format_volatility }}</td>
                    <td data-column="volatility_1h" class="volatility-cell">{{ snapshot.volatility_1h|format_volatility }}</td>
                    <td data-column="ticks_5m" class="ticks-cell">{{ snapshot.ticks_5m }}</td>
                    <td data-column="ticks_15m" class="ticks-cell">{{ snapshot.ticks_15m }}</td>
                    <td data-column="ticks_1h" class="ticks-cell">{{ snapshot.ticks_1h }}</td>
                    <td data-column="vdelta_5m" class="vdelta-cell">{{ snapshot.vdelta_5m|format_vdelta }}</td>
                    <td data-column="vdelta_15m" class="vdelta-cell">{{ snapshot.vdelta_15m|format_vdelta }}</td>
                    <td data-column="vdelta_1h" class="vdelta-cell">{{ snapshot.vdelta_1h|format_vdelta }}</td>
                    <td data-column="vdelta_8h" class="vdelta-cell">{{ snapshot.vdelta_8h|format_vdelta }}</td>
                    <td data-column="vdelta_1d" class="vdelta-cell">{{ snapshot.vdelta_1d|format_vdelta }}</td>
                    <td data-column="volume_5m" class="volume-cell">{{ snapshot.volume_5m|format_volume }}</td>
                    <td data-column="volume_15m" class="volume-cell">{{ snapshot.volume_15m|format_volume }}</td>
                    <td data-column="volume_1h" class="volume-cell">{{ snapshot.volume_1h|format_volume }}</td>
                    <td data-column="volume_8h" class="volume-cell">{{ snapshot.volume_8h|format_volume }}</td>
                    <td data-column="volume_1d" class="volume-cell">{{ snapshot.volume_1d|format_volume }}</td>
                    <td data-column="funding_rate" class="funding-cell">{{ snapshot.funding_rate|format_percentage:4 }}</td>
                    <td data-column="open_interest" class="oi-cell">{{ snapshot.open_interest|format_volume }}</td>
                    <td data-column="ts">{{ snapshot.ts }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="31" class="empty-row">{% trans "No data to display." %}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        </div>
    </div>

    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&market_type={{ market_type }}&search={{ search }}&min_volume_15m={{ min_volume_15m }}&max_volume_15m={{ max_volume_15m }}&min_change_15m={{ min_change_15m }}&max_change_15m={{ max_change_15m }}&min_oi_change_15m={{ min_oi_change_15m }}&min_open_interest={{ min_open_interest }}&max_open_interest={{ max_open_interest }}&min_funding_rate={{ min_funding_rate }}&max_funding_rate={{ max_funding_rate }}&sort={{ sort }}&order={{ order }}">&laquo; {% trans "Previous" %}</a>
        {% endif %}
        <span>{% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&market_type={{ market_type }}&search={{ search }}&min_volume_15m={{ min_volume_15m }}&max_volume_15m={{ max_volume_15m }}&min_change_15m={{ min_change_15m }}&max_change_15m={{ max_change_15m }}&min_oi_change_15m={{ min_oi_change_15m }}&min_open_interest={{ min_open_interest }}&max_open_interest={{ max_open_interest }}&min_funding_rate={{ min_funding_rate }}&max_funding_rate={{ max_funding_rate }}&sort={{ sort }}&order={{ order }}">{% trans "Next" %} &raquo;</a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    window.SCREENER_AVAILABLE_COLUMNS = [
        "symbol",
        "price",
        "change_5m",
        "change_15m",
        "change_1h",
        "change_8h",
        "change_1d",
        "oi_change_5m",
        "oi_change_15m",
        "oi_change_1h",
        "oi_change_8h",
        "oi_change_1d",
        "volatility_5m",
        "volatility_15m",
        "volatility_1h",
        "ticks_5m",
        "ticks_15m",
        "ticks_1h",
        "vdelta_5m",
        "vdelta_15m",
        "vdelta_1h",
        "vdelta_8h",
        "vdelta_1d",
        "volume_5m",
        "volume_15m",
        "volume_1h",
        "volume_8h",
        "volume_1d",
        "funding_rate",
        "open_interest",
        "ts",
    ];
    
    // Market type toggle handler - use event delegation to avoid conflicts
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.market-type-toggle .market-type-btn[data-market-type]');
        if (!btn) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const newMarketType = btn.getAttribute('data-market-type');
        if (!newMarketType) return;
        
        const url = new URL(window.location);
        url.searchParams.delete('market_type');
        url.searchParams.set('market_type', newMarketType);
        window.location.href = url.toString();
    }, true);
</script>
{% endblock %}
