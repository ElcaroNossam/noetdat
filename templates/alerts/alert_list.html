{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Alerts" %}{% endblock %}

{% block content %}
<div class="alerts-container">
    <div class="alerts-header">
        <h1>{% trans "Alert Management" %}</h1>
        <div class="alerts-filters">
            <form method="get" class="alerts-filter-form">
                <input type="text" name="search" placeholder="{% trans 'Search by symbol' %}" value="{{ search }}">
                <select name="market_type">
                    <option value="">{% trans "All markets" %}</option>
                    <option value="futures" {% if market_type == 'futures' %}selected{% endif %}>{% trans "Futures" %}</option>
                    <option value="spot" {% if market_type == 'spot' %}selected{% endif %}>{% trans "Spot" %}</option>
                </select>
                <select name="active">
                    <option value="">{% trans "All" %}</option>
                    <option value="true" {% if active_filter == 'true' %}selected{% endif %}>{% trans "Active" %}</option>
                    <option value="false" {% if active_filter == 'false' %}selected{% endif %}>{% trans "Inactive" %}</option>
                </select>
                <button type="submit" class="btn-secondary">{% trans "Filter" %}</button>
                <a href="{% url 'alerts:list' %}" class="btn-secondary">{% trans "Reset" %}</a>
            </form>
        </div>
    </div>

    {% if alerts %}
        <div class="alerts-table-container">
            <table class="alerts-table">
                <thead>
                    <tr>
                        <th>{% trans "Symbol" %}</th>
                        <th>{% trans "Metric" %}</th>
                        <th>{% trans "Condition" %}</th>
                        <th>{% trans "Threshold" %}</th>
                        <th>{% trans "Telegram ID" %}</th>
                        <th>{% trans "Status" %}</th>
                        <th>{% trans "Created" %}</th>
                        <th>{% trans "Last Triggered" %}</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in alerts %}
                        <tr class="{% if not alert.active %}alert-inactive{% endif %}">
                            <td>
                                <a href="{% url 'screener:symbol_detail' alert.symbol.symbol %}?market_type={{ alert.symbol.market_type }}">
                                    {{ alert.symbol.symbol }}
                                </a>
                            </td>
                            <td>{{ alert.get_metric_display }}</td>
                            <td>{{ alert.operator }}</td>
                            <td>{{ alert.threshold }}</td>
                            <td>{{ alert.telegram_chat_id|default:"—" }}</td>
                            <td>
                                <span class="alert-status {% if alert.active %}alert-active{% else %}alert-inactive-status{% endif %}">
                                    {% if alert.active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                                </span>
                            </td>
                            <td>{{ alert.created_at|date:"d.m.Y H:i" }}</td>
                            <td>{{ alert.last_triggered_at|date:"d.m.Y H:i"|default:"—" }}</td>
                            <td class="alert-actions">
                                <form method="post" action="{% url 'alerts:toggle' alert.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-small {% if alert.active %}btn-warning{% else %}btn-success{% endif %}">
                                        {% if alert.active %}{% trans "Deactivate" %}{% else %}{% trans "Activate" %}{% endif %}
                                    </button>
                                </form>
                                <a href="{% url 'alerts:edit' alert.id %}" class="btn-small btn-secondary">{% trans "Edit" %}</a>
                                <form method="post" action="{% url 'alerts:delete' alert.id %}" style="display: inline;" onsubmit="return confirm('{% trans 'Delete this alert?' %}');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-small btn-danger">{% trans "Delete" %}</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <p>{% trans "You don't have any alerts yet." %}</p>
            <p>{% trans "Create an alert on the symbol page to receive notifications." %}</p>
        </div>
    {% endif %}
</div>
{% endblock %}

