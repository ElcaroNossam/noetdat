# Исправление проблемы с переводами

## Проблема
Язык сохраняется, но страницы не переводятся согласно выбранному языку, или язык слетает на английский.

## Причина
1. **Файлы переводов не скомпилированы** - Django использует `.mo` файлы, а не `.po`
2. **Accept-Language заголовок браузера** переопределяет язык (браузер может отправлять английский)
3. Язык не правильно определяется из URL и cookie

## Решение

### На сервере выполни:

```bash
cd ~/project/noetdat
source venv/bin/activate

# 1. Скомпилируй переводы (это создаст .mo файлы из .po)
python manage.py compilemessages

# 2. Перезапусти сервис
sudo systemctl restart noetdat

# 3. Проверь, что .mo файлы созданы
ls -la locale/*/LC_MESSAGES/*.mo
```

### Если команда `compilemessages` не работает:

```bash
# Установи gettext (если еще не установлен)
sudo apt-get update
sudo apt-get install -y gettext

# Затем снова скомпилируй
python manage.py compilemessages
```

### Что было исправлено:

1. **Добавлен кастомный middleware** (`ForceLanguageMiddleware`) который:
   - Определяет язык ТОЛЬКО из URL и cookie
   - Игнорирует Accept-Language заголовок браузера
   - Гарантирует, что язык не слетает на английский

2. **Улучшены настройки cookie** для языка:
   - `LANGUAGE_COOKIE_PATH = '/'` - cookie доступен для всего сайта
   - Правильные настройки для сохранения языка

### Проверка после исправления:

1. Открой сайт: `https://elcaro.online`
2. Переключи язык на английский
3. Проверь, что все тексты переведены
4. Обнови страницу - язык должен сохраниться
5. Закрой и открой браузер - язык должен сохраниться

## Дополнительная информация

- `.po` файлы - это исходные файлы переводов (текстовые)
- `.mo` файлы - это скомпилированные файлы переводов (бинарные, используются Django)
- Команда `compilemessages` создает `.mo` файлы из `.po` файлов
- После каждого изменения в `.po` файлах нужно запускать `compilemessages`
- `ForceLanguageMiddleware` гарантирует, что язык определяется только из URL и cookie, не из браузера

